<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF Monitor Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e); min-height: 100vh; color: #fff; }
        .header { background: rgba(255,255,255,0.1); padding: 20px; text-align: center; }
        .header h1 { font-size: 1.8em; }
        .last-update { color: #aaa; font-size: 0.9em; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .summary-card { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; }
        .summary-card.buy { border-left: 4px solid #00B050; }
        .summary-card.sell { border-left: 4px solid #DC3545; }
        .summary-card.hold { border-left: 4px solid #FFC000; }
        .summary-card.total { border-left: 4px solid #4472C4; }
        .summary-card .number { font-size: 2.5em; font-weight: bold; }
        .summary-card.buy .number { color: #00B050; }
        .summary-card.sell .number { color: #DC3545; }
        .summary-card.hold .number { color: #FFC000; }
        .summary-card.total .number { color: #4472C4; }
        .level-section { background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .level-header { padding: 12px 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .level-1 .level-header { background: linear-gradient(90deg, #00B050, #00D060); }
        .level-2 .level-header { background: linear-gradient(90deg, #FFC000, #FFD000); color: #333; }
        .level-3 .level-header { background: linear-gradient(90deg, #4472C4, #5A8FD4); }
        .fund-table { width: 100%; border-collapse: collapse; }
        .fund-table th { background: rgba(0,0,0,0.3); padding: 10px 12px; text-align: left; font-size: 0.85em; }
        .fund-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.9em; }
        .fund-table tr:hover { background: rgba(255,255,255,0.05); }
        .signal { display: inline-block; padding: 4px 12px; border-radius: 15px; font-weight: bold; font-size: 0.8em; }
        .signal.buy { background: #00B050; }
        .signal.sell { background: #DC3545; }
        .signal.hold { background: #FFC000; color: #333; }
        .rsi { font-weight: bold; }
        .rsi.low { color: #00B050; }
        .rsi.mid { color: #FFC000; }
        .rsi.high { color: #DC3545; }
        .macd { font-weight: bold; }
        .macd.positive { color: #00B050; }
        .macd.negative { color: #DC3545; }
        .macd.neutral { color: #FFC000; }
        .bbw { font-weight: bold; }
        .bbw.wide { color: #00B050; }
        .bbw.narrow { color: #aaa; }
        .crossover { font-size: 0.75em; padding: 2px 8px; border-radius: 10px; }
        .crossover.golden { background: #00B050; color: white; }
        .crossover.death { background: #DC3545; color: white; }
        .crossover.neutral { background: rgba(255,255,255,0.15); color: #aaa; }
        .buy-count { font-size: 0.8em; color: #aaa; }
        .etf-name { max-width: 350px; word-wrap: break-word; line-height: 1.3; }
        .empty-msg { padding: 30px; text-align: center; color: #888; }
        .category-filters { margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; }
        .cat-btn { padding: 6px 14px; border: none; border-radius: 15px; background: rgba(255,255,255,0.15); color: #fff; cursor: pointer; }
        .cat-btn:hover, .cat-btn.active { background: #4472C4; }
        .legend { margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.85em; color: #aaa; }
        .legend strong { color: #fff; }
        @media (max-width: 768px) { .fund-table { font-size: 0.75em; } .fund-table th, .fund-table td { padding: 6px 8px; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>ETF Monitor Dashboard</h1>
        <div class="last-update" id="lastUpdate">Caricamento...</div>
    </div>

    <div class="container">
        <div class="summary-grid">
            <div class="summary-card total"><div class="number" id="totalETFs">-</div><div>ETF Totali</div></div>
            <div class="summary-card buy"><div class="number" id="buySignals">-</div><div>Segnali BUY</div></div>
            <div class="summary-card hold"><div class="number" id="holdSignals">-</div><div>Segnali HOLD</div></div>
            <div class="summary-card sell"><div class="number" id="sellSignals">-</div><div>Segnali SELL</div></div>
        </div>

        <div class="legend">
            <strong>Condizioni BUY (5/5 richieste):</strong>
            1. Prezzo &gt; EMA13 &amp; SMA50 per 3+ gg |
            2. EMA13 &gt; SMA50 (Golden Cross) |
            3. RSI 55-65 |
            4. MACD positivo e crescente |
            5. Bollinger Band Width in espansione
            &nbsp; | &nbsp; <em>Fonte dati: JustETF</em>
        </div>

        <div class="category-filters" id="categoryFilters"></div>

        <div class="level-section level-1">
            <div class="level-header"><span>LIVELLO 1 - BUY Alert</span><span id="l1Count">0 ETF</span></div>
            <table class="fund-table"><thead><tr><th>ETF</th><th>Ticker</th><th>Prezzo</th><th>EMA13</th><th>SMA50</th><th>RSI</th><th>MACD</th><th>BB W</th><th>Cross</th><th>Segnale</th></tr></thead><tbody id="level1Body"></tbody></table>
        </div>

        <div class="level-section level-2">
            <div class="level-header"><span>LIVELLO 2 - Watchlist</span><span id="l2Count">0 ETF</span></div>
            <table class="fund-table"><thead><tr><th>ETF</th><th>Ticker</th><th>Prezzo</th><th>EMA13</th><th>SMA50</th><th>RSI</th><th>MACD</th><th>BB W</th><th>Cross</th><th>Segnale</th></tr></thead><tbody id="level2Body"></tbody></table>
        </div>

        <div class="level-section level-3">
            <div class="level-header"><span>LIVELLO 3 - Universe</span><span id="l3Count">0 ETF</span></div>
            <table class="fund-table"><thead><tr><th>ETF</th><th>Categoria</th><th>Prezzo</th><th>EMA13</th><th>SMA50</th><th>RSI</th><th>MACD</th><th>BB W</th><th>Cross</th><th>Segnale</th></tr></thead><tbody id="level3Body"></tbody></table>
        </div>
    </div>

    <script>
        let allData = null;
        let activeCategory = 'all';

        async function loadData() {
            try {
                const response = await fetch('data/dashboard_data.json');
                allData = await response.json();
                renderDashboard();
            } catch (e) {
                document.getElementById('lastUpdate').textContent = 'Errore caricamento dati';
                console.error(e);
            }
        }

        function renderDashboard() {
            if (!allData) return;

            const dt = new Date(allData.last_update);
            document.getElementById('lastUpdate').textContent = `Ultimo aggiornamento: ${dt.toLocaleString('it-IT')}`;

            document.getElementById('totalETFs').textContent = allData.summary.total_etfs || 0;
            document.getElementById('buySignals').textContent = allData.summary.buy_signals;
            document.getElementById('holdSignals').textContent = allData.summary.hold_signals;
            document.getElementById('sellSignals').textContent = allData.summary.sell_signals;

            // Category filters
            const categories = Object.keys(allData.categories || {});
            const filterHtml = `<button class="cat-btn ${activeCategory==='all'?'active':''}" onclick="filterCategory('all')">Tutti</button>` +
                categories.map(c => `<button class="cat-btn ${activeCategory===c?'active':''}" onclick="filterCategory('${c}')">${c}</button>`).join('');
            document.getElementById('categoryFilters').innerHTML = filterHtml;

            renderLevel(1, allData.levels['1'] || []);
            renderLevel(2, allData.levels['2'] || []);
            renderLevel(3, allData.levels['3'] || []);
        }

        function filterCategory(cat) {
            activeCategory = cat;
            renderDashboard();
        }

        function renderLevel(level, etfs) {
            const filtered = activeCategory === 'all' ? etfs : etfs.filter(f => f.categoria === activeCategory);
            const tbody = document.getElementById(`level${level}Body`);
            document.getElementById(`l${level}Count`).textContent = `${filtered.length} ETF`;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="empty-msg">Nessun ETF in questo livello</td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(f => {
                const rsiClass = f.rsi < 30 ? 'low' : f.rsi > 70 ? 'high' : 'mid';
                const macdH = f.macd_histogram;
                const macdClass = macdH > 0 ? 'positive' : macdH < 0 ? 'negative' : 'neutral';
                const bbwClass = f.bb_width >= 5 ? 'wide' : 'narrow';
                const signalClass = f.signal ? f.signal.toLowerCase() : 'hold';
                const crossClass = f.crossover === 'golden_cross' ? 'golden' : f.crossover === 'death_cross' ? 'death' : 'neutral';
                const crossLabel = f.crossover === 'golden_cross' ? 'Golden' : f.crossover === 'death_cross' ? 'Death' : '-';
                const secondCol = level === 3 ? f.categoria : f.ticker;
                const isinTip = f.isin ? f.isin + ' | ' + f.ticker : f.ticker;

                return `<tr>
                    <td class="etf-name" title="${isinTip}">${f.nome || '-'}</td>
                    <td>${secondCol || '-'}</td>
                    <td>${f.price ? f.price.toFixed(2) : '-'}</td>
                    <td>${f.ema13 ? f.ema13.toFixed(2) : '-'}</td>
                    <td>${f.sma50 ? f.sma50.toFixed(2) : '-'}</td>
                    <td class="rsi ${rsiClass}">${f.rsi ? f.rsi.toFixed(0) : '-'}</td>
                    <td class="macd ${macdClass}">${macdH != null ? macdH.toFixed(2) : '-'}</td>
                    <td class="bbw ${bbwClass}">${f.bb_width ? f.bb_width.toFixed(1) : '-'}</td>
                    <td><span class="crossover ${crossClass}">${crossLabel}</span></td>
                    <td><span class="signal ${signalClass}">${f.signal || 'HOLD'}</span> <span class="buy-count">${f.buy_count || 0}/5</span></td>
                </tr>`;
            }).join('');
        }

        loadData();
        setInterval(loadData, 60000);
    </script>
</body>
</html>
