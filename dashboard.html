<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF Monitor Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e, #16213e); min-height: 100vh; color: #fff; }
        .header { position: sticky; top: 0; z-index: 100; background: rgba(22,33,62,0.95); backdrop-filter: blur(8px); padding: 8px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .header h1 { font-size: 1.1em; white-space: nowrap; }
        .last-update { color: #aaa; font-size: 0.75em; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .summary-bar { display: flex; gap: 12px; align-items: center; }
        .summary-item { display: flex; align-items: center; gap: 4px; font-size: 0.85em; }
        .summary-item .number { font-weight: bold; font-size: 1.1em; }
        .summary-item.buy .number { color: #00B050; }
        .summary-item.sell .number { color: #DC3545; }
        .summary-item.hold .number { color: #FFC000; }
        .summary-item.total .number { color: #4472C4; }
        .summary-item .label { color: #aaa; font-size: 0.8em; }
        .container { max-width: 1600px; margin: 0 auto; padding: 15px 20px; }
        .level-section { background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .level-header { padding: 12px 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .level-1 .level-header { background: linear-gradient(90deg, #00B050, #00D060); }
        .level-2 .level-header { background: linear-gradient(90deg, #FFC000, #FFD000); color: #333; }
        .level-3 .level-header { background: linear-gradient(90deg, #4472C4, #5A8FD4); }
        /* Column widths shared between header and tables */
        .col-etf { width: 22%; } .col-ticker { width: 8%; } .col-prezzo { width: 7%; }
        .col-pct { width: 6%; } .col-ema { width: 7%; } .col-sma { width: 7%; }
        .col-rsi { width: 5%; } .col-macd { width: 6%; } .col-bbw { width: 5%; } .col-buy { width: 5%; }
        .column-header { position: sticky; top: 38px; z-index: 99; background: rgba(10,15,30,0.97); backdrop-filter: blur(8px); border-bottom: 2px solid rgba(255,255,255,0.15); padding: 0 20px; }
        .column-header table { width: 100%; max-width: 1560px; margin: 0 auto; border-collapse: collapse; table-layout: fixed; }
        .column-header th { padding: 8px 8px; text-align: left; font-size: 0.8em; font-weight: bold; color: #aaa; overflow: hidden; }
        .fund-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .fund-table thead { display: none; }
        .fund-table td { padding: 8px 8px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.85em; overflow: hidden; text-overflow: ellipsis; }
        .fund-table tr:hover { background: rgba(255,255,255,0.05); }
        .rsi { font-weight: bold; }
        .rsi.low { color: #00B050; }
        .rsi.mid { color: #FFC000; }
        .rsi.high { color: #DC3545; }
        .macd { font-weight: bold; }
        .macd.positive { color: #00B050; }
        .macd.negative { color: #DC3545; }
        .macd.neutral { color: #FFC000; }
        .bbw { font-weight: bold; }
        .bbw.wide { color: #00B050; }
        .bbw.narrow { color: #aaa; }
        .pct { font-weight: bold; }
        .pct.pos { color: #00B050; }
        .pct.neg { color: #DC3545; }
        .pct.zero { color: #aaa; }
        .buy-count { font-weight: bold; font-size: 0.85em; }
        .buy-count.pullback { color: #FF8C00; }
        .buy-count.full-buy { color: #00B050; }
        .pullback-tag { display: inline-block; font-size: 0.68em; padding: 1px 5px; border-radius: 3px; background: #FF8C00; color: #fff; margin-left: 4px; vertical-align: middle; }
        .limit-price { display: block; font-size: 0.68em; color: #FF8C00; font-style: italic; }
        .etf-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.3; }
        .empty-msg { padding: 30px; text-align: center; color: #888; }
        .category-filters { margin-bottom: 15px; display: flex; gap: 8px; flex-wrap: wrap; }
        .cat-btn { padding: 6px 14px; border: none; border-radius: 15px; background: rgba(255,255,255,0.15); color: #fff; cursor: pointer; }
        .cat-btn:hover, .cat-btn.active { background: #4472C4; }
        .legend { margin-bottom: 12px; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.78em; color: #aaa; }
        .legend strong { color: #fff; }
        @media (max-width: 768px) { .header { flex-wrap: wrap; gap: 4px; } .fund-table td, .column-header th { padding: 6px 4px; font-size: 0.72em; } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>ETF Monitor</h1>
            <div class="summary-bar">
                <div class="summary-item total"><span class="number" id="totalETFs">-</span><span class="label">Totali</span></div>
                <div class="summary-item buy"><span class="number" id="buySignals">-</span><span class="label">BUY</span></div>
                <div class="summary-item" style="color:#FF8C00"><span class="number" id="pullbackSignals" style="color:#FF8C00">-</span><span class="label">PULLBACK</span></div>
                <div class="summary-item hold"><span class="number" id="holdSignals">-</span><span class="label">HOLD</span></div>
                <div class="summary-item sell"><span class="number" id="sellSignals">-</span><span class="label">SELL</span></div>
            </div>
        </div>
        <div class="last-update" id="lastUpdate">Caricamento...</div>
    </div>

    <div class="column-header">
        <table>
            <colgroup><col class="col-etf"><col class="col-ticker"><col class="col-prezzo"><col class="col-pct"><col class="col-pct"><col class="col-pct"><col class="col-ema"><col class="col-sma"><col class="col-rsi"><col class="col-macd"><col class="col-bbw"><col class="col-buy"></colgroup>
            <tr><th>ETF</th><th>Ticker</th><th>Prezzo</th><th>%1G</th><th>%1W</th><th>%1M</th><th>EMA13</th><th>SMA50</th><th>RSI</th><th>MACD</th><th>BB W</th><th>BUY</th></tr>
        </table>
    </div>

    <div class="container">

        <div class="legend">
            <strong>Condizioni BUY (5/5 richieste):</strong>
            1. Prezzo &gt; EMA13 &amp; SMA50 per 3+ gg |
            2. EMA13 &gt; SMA50 (Golden Cross) |
            3. RSI 55-65 |
            4. MACD positivo e crescente |
            5. Bollinger Band Width in espansione
            <br><strong style="color:#FF8C00">Filtro Pullback:</strong> Se 5/5 ma Prezzo &gt; 5% da EMA13 &rarr; BUY sospeso. Limit Order suggerito: EMA13 + 2%
            &nbsp; | &nbsp; <em>Fonte dati: JustETF</em>
        </div>

        <div class="category-filters" id="categoryFilters"></div>

        <div class="level-section level-1">
            <div class="level-header"><span>LIVELLO 1 - BUY Alert</span><span id="l1Count">0 ETF</span></div>
            <table class="fund-table">
                <colgroup><col class="col-etf"><col class="col-ticker"><col class="col-prezzo"><col class="col-pct"><col class="col-pct"><col class="col-pct"><col class="col-ema"><col class="col-sma"><col class="col-rsi"><col class="col-macd"><col class="col-bbw"><col class="col-buy"></colgroup>
                <thead><tr><th>ETF</th><th>Ticker</th><th>Prezzo</th><th>%1G</th><th>%1W</th><th>%1M</th><th>EMA13</th><th>SMA50</th><th>RSI</th><th>MACD</th><th>BB W</th><th>BUY</th></tr></thead>
                <tbody id="level1Body"></tbody>
            </table>
        </div>

        <div class="level-section level-2">
            <div class="level-header"><span>LIVELLO 2 - Watchlist</span><span id="l2Count">0 ETF</span></div>
            <table class="fund-table">
                <colgroup><col class="col-etf"><col class="col-ticker"><col class="col-prezzo"><col class="col-pct"><col class="col-pct"><col class="col-pct"><col class="col-ema"><col class="col-sma"><col class="col-rsi"><col class="col-macd"><col class="col-bbw"><col class="col-buy"></colgroup>
                <thead><tr><th>ETF</th><th>Ticker</th><th>Prezzo</th><th>%1G</th><th>%1W</th><th>%1M</th><th>EMA13</th><th>SMA50</th><th>RSI</th><th>MACD</th><th>BB W</th><th>BUY</th></tr></thead>
                <tbody id="level2Body"></tbody>
            </table>
        </div>

        <div class="level-section level-3">
            <div class="level-header"><span>LIVELLO 3 - Universe</span><span id="l3Count">0 ETF</span></div>
            <table class="fund-table">
                <colgroup><col class="col-etf"><col class="col-ticker"><col class="col-prezzo"><col class="col-pct"><col class="col-pct"><col class="col-pct"><col class="col-ema"><col class="col-sma"><col class="col-rsi"><col class="col-macd"><col class="col-bbw"><col class="col-buy"></colgroup>
                <thead><tr><th>ETF</th><th>Categoria</th><th>Prezzo</th><th>%1G</th><th>%1W</th><th>%1M</th><th>EMA13</th><th>SMA50</th><th>RSI</th><th>MACD</th><th>BB W</th><th>BUY</th></tr></thead>
                <tbody id="level3Body"></tbody>
            </table>
        </div>
    </div>

    <script>
        let allData = null;
        let activeCategory = 'all';

        async function loadData() {
            try {
                const response = await fetch('data/dashboard_data.json');
                allData = await response.json();
                renderDashboard();
            } catch (e) {
                document.getElementById('lastUpdate').textContent = 'Errore caricamento dati';
                console.error(e);
            }
        }

        function renderDashboard() {
            if (!allData) return;

            const dt = new Date(allData.last_update);
            document.getElementById('lastUpdate').textContent = `Ultimo aggiornamento: ${dt.toLocaleString('it-IT')}`;

            document.getElementById('totalETFs').textContent = allData.summary.total_etfs || 0;
            document.getElementById('buySignals').textContent = allData.summary.buy_signals || 0;
            document.getElementById('pullbackSignals').textContent = allData.summary.pullback_signals || 0;
            document.getElementById('holdSignals').textContent = allData.summary.hold_signals || 0;
            document.getElementById('sellSignals').textContent = allData.summary.sell_signals || 0;

            // Category filters
            const categories = Object.keys(allData.categories || {});
            const filterHtml = `<button class="cat-btn ${activeCategory==='all'?'active':''}" onclick="filterCategory('all')">Tutti</button>` +
                categories.map(c => `<button class="cat-btn ${activeCategory===c?'active':''}" onclick="filterCategory('${c}')">${c}</button>`).join('');
            document.getElementById('categoryFilters').innerHTML = filterHtml;

            renderLevel(1, allData.levels['1'] || []);
            renderLevel(2, allData.levels['2'] || []);
            renderLevel(3, allData.levels['3'] || []);
        }

        function filterCategory(cat) {
            activeCategory = cat;
            renderDashboard();
        }

        function renderLevel(level, etfs) {
            const filtered = activeCategory === 'all' ? etfs : etfs.filter(f => f.categoria === activeCategory);
            const tbody = document.getElementById(`level${level}Body`);
            document.getElementById(`l${level}Count`).textContent = `${filtered.length} ETF`;

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="12" class="empty-msg">Nessun ETF in questo livello</td></tr>`;
                return;
            }

            tbody.innerHTML = filtered.map(f => {
                const rsiClass = f.rsi < 30 ? 'low' : f.rsi > 70 ? 'high' : 'mid';
                const macdH = f.macd_histogram;
                const macdClass = macdH > 0 ? 'positive' : macdH < 0 ? 'negative' : 'neutral';
                const bbwClass = f.bb_width >= 5 ? 'wide' : 'narrow';
                const secondCol = level === 3 ? f.categoria : f.ticker;
                const isinTip = f.isin ? f.isin + ' | ' + f.ticker : f.ticker;
                const distTip = f.distance_from_ema != null ? `Dist. EMA13: ${f.distance_from_ema.toFixed(1)}%` : '';
                const fmtPct = v => {
                    if (v == null) return '<td class="pct zero">-</td>';
                    const cls = v > 0 ? 'pos' : v < 0 ? 'neg' : 'zero';
                    const sign = v > 0 ? '+' : '';
                    return `<td class="pct ${cls}">${sign}${v.toFixed(2)}%</td>`;
                };

                // Colonna BUY con filtro pullback
                let buyCell;
                if (f.pullback_active) {
                    const limitTxt = f.limit_order_price ? `Limit: ${f.limit_order_price.toFixed(2)}` : '';
                    buyCell = `<td class="buy-count pullback" title="${distTip}">${f.buy_count}/5<span class="pullback-tag">PB</span><span class="limit-price">${limitTxt}</span></td>`;
                } else if (f.buy_count === 5) {
                    buyCell = `<td class="buy-count full-buy" title="${distTip}">${f.buy_count}/5</td>`;
                } else {
                    buyCell = `<td class="buy-count" title="${distTip}">${f.buy_count || 0}/5</td>`;
                }

                return `<tr>
                    <td class="etf-name" title="${isinTip}">${f.nome || '-'}</td>
                    <td>${secondCol || '-'}</td>
                    <td>${f.price ? f.price.toFixed(2) : '-'}</td>
                    ${fmtPct(f.pct_1d)}
                    ${fmtPct(f.pct_1w)}
                    ${fmtPct(f.pct_1m)}
                    <td>${f.ema13 ? f.ema13.toFixed(2) : '-'}</td>
                    <td>${f.sma50 ? f.sma50.toFixed(2) : '-'}</td>
                    <td class="rsi ${rsiClass}">${f.rsi ? f.rsi.toFixed(0) : '-'}</td>
                    <td class="macd ${macdClass}">${macdH != null ? macdH.toFixed(2) : '-'}</td>
                    <td class="bbw ${bbwClass}">${f.bb_width ? f.bb_width.toFixed(1) : '-'}</td>
                    ${buyCell}
                </tr>`;
            }).join('');
        }

        loadData();
        setInterval(loadData, 60000);
    </script>
</body>
</html>
